{% extends "base.html" %}

{% block title %}{{ book.title }} - Школьная библиотека{% endblock %}

{% block content %}
<div class="container">
    <div class="book-detail">
        <!-- Хлебные крошки -->
        <nav class="breadcrumb">
            <a href="{{ url_for('index') }}">Главная</a>
            <span class="separator">/</span>
            <a href="{{ url_for('catalog') }}">Каталог</a>
            <span class="separator">/</span>
            <span class="current">{{ book.title }}</span>
        </nav>

        <div class="book-detail-content">
            <!-- Левая колонка - обложка и информация -->
            <div class="book-left">
                <div class="book-cover-large">
                    <i class="fas fa-book"></i>
                    <!-- Индикатор статуса для админа -->
                    {% if user and user.username == 'admin' %}
                    <div class="status-indicator {{ 'status-available' if book.available else 'status-unavailable' }}">
                        <i class="fas fa-{{ 'check-circle' if book.available else 'times-circle' }}"></i>
                        {{ 'Доступна' if book.available else 'На руках' }}
                    </div>
                    {% endif %}
                    
                    <!-- Индикатор чтения для обычных пользователей -->
                    {% if user and user.username != 'admin' and is_reading %}
                    <div class="reading-indicator">
                        <i class="fas fa-book-open"></i>
                        Читаю сейчас
                    </div>
                    {% endif %}
                </div>
                
                <div class="book-meta">
                    <div class="meta-item">
                        <strong>Темы:</strong>
                        <div class="theme-tags">
                            {% for theme in book.theme %}
                            <span class="theme-tag">{{ theme }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="meta-item">
                        <strong>Год издания:</strong>
                        <span>{{ book.year }}</span>
                    </div>
                    <div class="meta-item">
                        <strong>ID книги:</strong>
                        <span>#{{ book.id }}</span>
                    </div>
                </div>

                {% if user %}
                <div class="book-actions">
                    <!-- Кнопки для обычных пользователей -->
                    {% if user.username != 'admin' %}
                        {% if is_reading %}
                        <a href="{{ url_for('toggle_reading', book_id=book.id) }}" class="btn-reading btn-reading-active" onclick="return confirm('Завершить чтение книги? Она будет перемещена в историю.')">
                            <i class="fas fa-book-open"></i>
                            Читаю книгу ✓
                        </a>
                        {% else %}
                        <a href="{{ url_for('toggle_reading', book_id=book.id) }}" class="btn-reading">
                            <i class="fas fa-book"></i>
                            Читать книгу
                        </a>
                        {% endif %}
                    {% endif %}
                    
                    <!-- Кнопка избранного для всех пользователей -->
                    {% if is_favorite %}
                    <a href="{{ url_for('remove_from_favorites', book_id=book.id) }}" class="btn-favorite btn-favorite-active">
                        <i class="fas fa-heart"></i>
                        В избранном
                    </a>
                    {% else %}
                    <a href="{{ url_for('add_to_favorites', book_id=book.id) }}" class="btn-favorite">
                        <i class="far fa-heart"></i>
                        В избранное
                    </a>
                    {% endif %}
                </div>
                {% else %}
                <div class="login-prompt">
                    <p>Для добавления книг необходимо войти в систему</p>
                    <a href="{{ url_for('login') }}" class="btn-primary">Войти</a>
                    <a href="{{ url_for('register') }}" class="btn-secondary">Зарегистрироваться</a>
                </div>
                {% endif %}
            </div>

            <!-- Правая колонка - описание -->
            <div class="book-right">
                <h1 class="book-title">{{ book.title }}</h1>
                <p class="book-author">
                    <i class="fas fa-user-edit"></i>
                    {{ book.author }}
                </p>
                
                <div class="book-description">
                    <h3>Описание</h3>
                    <p>{{ book.description }}</p>
                </div>

                <div class="book-details">
                    <h3>Детали книги</h3>
                    <div class="details-grid">
                        <div class="detail-item">
                            <i class="fas fa-id-badge"></i>
                            <div>
                                <strong>ID книги</strong>
                                <span>#{{ book.id }}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-tags"></i>
                            <div>
                                <strong>Темы</strong>
                                <div class="theme-tags">
                                    {% for theme in book.theme %}
                                    <span class="theme-tag">{{ theme }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <div>
                                <strong>Год издания</strong>
                                <span>{{ book.year }}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Статус</strong>
                                <span class="status-text {{ 'available' if book.available else 'not-available' }}">
                                    {{ 'Доступна' if book.available else 'На руках' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Панель администратора -->
                {% if user and user.username == 'admin' %}
                <div class="admin-controls">
                    <h3>
                        <i class="fas fa-crown"></i>
                        Панель администратора
                    </h3>
                    
                    <div class="admin-stats">
                        <div class="admin-stat-card">
                            <i class="fas fa-{{ 'check-circle' if book.available else 'times-circle' }}"></i>
                            <div class="admin-stat-info">
                                <h4>Текущий статус</h4>
                                <p>{{ 'Доступна' if book.available else 'На руках' }}</p>
                            </div>
                        </div>
                        <div class="admin-stat-card">
                            <i class="fas fa-id-badge"></i>
                            <div class="admin-stat-info">
                                <h4>ID книги</h4>
                                <p>#{{ book.id }}</p>
                            </div>
                        </div>
                        <div class="admin-stat-card">
                            <i class="fas fa-calendar"></i>
                            <div class="admin-stat-info">
                                <h4>Год издания</h4>
                                <p>{{ book.year }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <a href="{{ url_for('toggle_book_status', book_id=book.id) }}" 
                       class="btn-status {{ 'btn-make-unavailable' if book.available else 'btn-make-available' }}"
                       onclick="return confirm('Изменить статус книги?')">
                        <i class="fas fa-{{ 'times-circle' if book.available else 'check-circle' }}"></i>
                        {% if book.available %}
                            Сделать книгу НЕДОСТУПНОЙ
                        {% else %}
                            Сделать книгу ДОСТУПНОЙ
                        {% endif %}
                    </a>
                    
                    <!-- Дополнительная информация для админа -->
                    <div class="admin-info">
                        <p><i class="fas fa-info-circle"></i> Как администратор, вы можете изменять статус книги. Статус "Доступна" означает, что книга есть в библиотеке, "На руках" - книга выдана читателю.</p>
                    </div>
                </div>
                {% endif %}

                <!-- Информация о чтении для обычных пользователей -->
                {% if user and user.username != 'admin' and is_reading %}
                <div class="reading-info-panel">
                    <h3>
                        <i class="fas fa-book-open"></i>
                        Информация о чтении
                    </h3>
                    <p>Вы начали читать эту книгу. Не забудьте завершить чтение, когда закончите - книга переместится в историю.</p>
                    <div class="reading-tips">
                        <div class="tip">
                            <i class="fas fa-check-circle"></i>
                            <span>Завершите чтение, чтобы книга появилась в истории</span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 2rem;
    font-size: 0.9rem;
}

.breadcrumb a {
    color: var(--primary-color);
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.breadcrumb .separator {
    color: var(--text-light);
}

.breadcrumb .current {
    color: var(--text-dark);
    font-weight: 500;
}

.book-detail-content {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 3rem;
    background: white;
    padding: 2rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
}

.book-cover-large {
    position: relative;
    background: linear-gradient(135deg, var(--bg-light), #e5e7eb);
    border-radius: var(--border-radius);
    padding: 3rem;
    text-align: center;
    font-size: 8rem;
    color: var(--primary-color);
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.status-indicator {
    position: absolute;
    top: 1rem;
    right: 1rem;
    padding: 0.5rem 1rem;
    border-radius: 30px;
    font-size: 0.9rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.status-indicator.status-available {
    background: #10b981;
    color: white;
}

.status-indicator.status-unavailable {
    background: #ef4444;
    color: white;
}

.reading-indicator {
    position: absolute;
    bottom: 1rem;
    left: 1rem;
    right: 1rem;
    background: rgba(16, 185, 129, 0.9);
    color: white;
    padding: 0.75rem;
    border-radius: 30px;
    font-size: 0.9rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    backdrop-filter: blur(5px);
}

.book-meta {
    background: var(--bg-light);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    margin-bottom: 2rem;
}

.meta-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e5e7eb;
}

.meta-item:last-child {
    border-bottom: none;
}

.meta-item strong {
    color: var(--text-dark);
}

.meta-item span {
    color: var(--primary-color);
    font-weight: 500;
}

.theme-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: flex-end;
}

.theme-tag {
    background: var(--bg-light);
    color: var(--primary-color);
    padding: 0.2rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    border: 1px solid var(--primary-color);
    white-space: nowrap;
}

.theme-tag:hover {
    background: var(--primary-color);
    color: white;
    cursor: default;
}

.book-actions {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.btn-reading, .btn-favorite, .btn-primary, .btn-secondary {
    padding: 1rem;
    border: none;
    border-radius: var(--border-radius);
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    text-decoration: none;
    text-align: center;
}

.btn-reading {
    background: var(--primary-color);
    color: white;
}

.btn-reading:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.btn-reading-active {
    background: #10b981;
    color: white;
}

.btn-reading-active:hover {
    background: #059669;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
}

.btn-secondary {
    background: #6b7280;
    color: white;
}

.btn-secondary:hover {
    background: #4b5563;
}

.btn-favorite {
    background: transparent;
    border: 2px solid #e5e7eb;
    color: var(--text-light);
}

.btn-favorite:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
    transform: translateY(-2px);
}

.btn-favorite-active {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.btn-favorite-active:hover {
    background: var(--primary-dark);
    border-color: var(--primary-dark);
}

.login-prompt {
    text-align: center;
    padding: 2rem;
    background: var(--bg-light);
    border-radius: var(--border-radius);
}

.login-prompt p {
    margin-bottom: 1.5rem;
    color: var(--text-dark);
}

.login-prompt .btn-primary, .login-prompt .btn-secondary {
    margin: 0.5rem;
    padding: 0.75rem 1.5rem;
    display: inline-block;
}

.book-title {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
    line-height: 1.2;
}

.book-author {
    font-size: 1.2rem;
    color: var(--primary-color);
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.book-description {
    margin-bottom: 2rem;
}

.book-description h3 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
    color: var(--text-dark);
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 0.5rem;
    display: inline-block;
}

.book-description p {
    line-height: 1.8;
    color: var(--text-dark);
}

.book-details {
    margin-bottom: 2rem;
}

.book-details h3 {
    font-size: 1.3rem;
    margin-bottom: 1rem;
    color: var(--text-dark);
}

.details-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-light);
    border-radius: var(--border-radius);
    transition: transform 0.3s;
}

.detail-item:hover {
    transform: translateX(5px);
}

.detail-item i {
    font-size: 1.5rem;
    color: var(--primary-color);
    width: 30px;
    text-align: center;
}

.detail-item div {
    display: flex;
    flex-direction: column;
    flex: 1;
}

.detail-item strong {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-bottom: 0.25rem;
}

.detail-item span {
    font-weight: 600;
    color: var(--text-dark);
}

.status-text {
    padding: 0.2rem 0.5rem;
    border-radius: 20px;
    font-size: 0.8rem;
    display: inline-block;
}

.status-text.available {
    background: #d1fae5;
    color: #065f46;
}

.status-text.not-available {
    background: #fee2e2;
    color: #991b1b;
}

/* Панель администратора */
.admin-controls {
    margin-top: 2rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, #fef3cd, #fde68a);
    border-radius: var(--border-radius);
    border-left: 4px solid #f59e0b;
}

.admin-controls h3 {
    color: #92400e;
    margin-bottom: 1.5rem;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.admin-controls h3 i {
    color: #f59e0b;
}

.admin-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.admin-stat-card {
    background: white;
    padding: 1rem;
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: var(--shadow);
}

.admin-stat-card i {
    font-size: 2rem;
    color: #f59e0b;
}

.admin-stat-info h4 {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-bottom: 0.25rem;
}

.admin-stat-info p {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-dark);
}

.btn-status {
    padding: 1rem;
    border-radius: var(--border-radius);
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 1rem;
    border: none;
    cursor: pointer;
    width: 100%;
    margin-bottom: 1rem;
}

.btn-make-available {
    background: #10b981;
    color: white;
}

.btn-make-available:hover {
    background: #059669;
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.btn-make-unavailable {
    background: #ef4444;
    color: white;
}

.btn-make-unavailable:hover {
    background: #dc2626;
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.admin-info {
    background: rgba(255, 255, 255, 0.5);
    padding: 1rem;
    border-radius: var(--border-radius);
    font-size: 0.9rem;
    color: #92400e;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.admin-info i {
    font-size: 1.2rem;
}

/* Панель информации о чтении */
.reading-info-panel {
    margin-top: 2rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    border-radius: var(--border-radius);
    border-left: 4px solid #10b981;
}

.reading-info-panel h3 {
    color: #065f46;
    margin-bottom: 1rem;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.reading-info-panel h3 i {
    color: #10b981;
}

.reading-info-panel p {
    color: #065f46;
    margin-bottom: 1rem;
    line-height: 1.6;
}

.reading-tips {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.tip {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #047857;
    font-size: 0.9rem;
}

.tip i {
    color: #10b981;
    font-size: 1rem;
}

/* Адаптация для планшетов */
@media (max-width: 968px) {
    .book-detail-content {
        grid-template-columns: 1fr;
        gap: 2rem;
    }
    
    .book-cover-large {
        max-width: 300px;
        margin: 0 auto 2rem;
        font-size: 6rem;
        min-height: 250px;
    }
    
    .admin-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Адаптация для мобильных */
@media (max-width: 768px) {
    .book-detail-content {
        padding: 1rem;
    }
    
    .book-cover-large {
        max-width: 250px;
        font-size: 5rem;
        min-height: 200px;
    }
    
    .book-title {
        font-size: 2rem;
    }
    
    .details-grid {
        grid-template-columns: 1fr;
    }
    
    .admin-stats {
        grid-template-columns: 1fr;
    }
    
    .status-indicator {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
    
    .reading-indicator {
        font-size: 0.8rem;
        padding: 0.5rem;
    }
    
    .book-author {
        font-size: 1rem;
    }
    
    .meta-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .theme-tags {
        justify-content: flex-start;
    }
}

/* Анимации */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.book-detail {
    animation: fadeIn 0.5s ease-out;
}
</style>

<script>
function showLoginPrompt() {
    if (confirm('Для добавления в избранное необходимо войти в систему. Перейти на страницу входа?')) {
        window.location.href = '/login';
    }
}

// Подтверждение для важных действий
document.addEventListener('DOMContentLoaded', function() {
    // Для кнопки завершения чтения
    const readingButton = document.querySelector('.btn-reading');
    if (readingButton && readingButton.classList.contains('btn-reading-active')) {
        readingButton.addEventListener('click', function(e) {
            if (!confirm('Завершить чтение книги? Она будет перемещена в историю.')) {
                e.preventDefault();
            }
        });
    }
    
    // Для кнопки изменения статуса (админ)
    const statusButton = document.querySelector('.btn-status');
    if (statusButton) {
        statusButton.addEventListener('click', function(e) {
            if (!confirm('Изменить статус книги?')) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}